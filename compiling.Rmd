---
title: "Compiling ziCPUE data"
author: "Lucas A. Nell"
date: "April 22, 2016"
output:
  html_document:
    highlight: haddock
    theme: journal
  pdf_document:
    highlight: haddock
    latex_engine: xelatex
mainfont: Helvetica
geometry: margin=1in
fontsize: 10pt
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
```

# Setup

### Required packages:
```{r libraries, message = FALSE}
library("dplyr")
library("tidyr")
library("readxl")
library("stringr")
```

### Reading files
The `compiling_preamble.R` file inputs tables into `tbl_df`s named 
`Apal`, `Suwa`, `Pearl`, and `Pasc`. I did this separately to keep names private.
```{r inputs}
options(stringsAsFactors = FALSE)
source('compiling_preamble.R')
```


In `compiling_preamble.R`, files were read and nothing else, as such:
```{r, eval = FALSE}
read_excel("FILENAME.xlsx")
read.csv("FILENAME.csv") %>% as.tbl
```



# Standardizing data frames

Each data frame was unique in its column names and overall setup. Below are some goals
we needed to achieve:

1. We needed as many of the following columns as possible: `Site`, `Date`, `V_TagID`,
   `V_Serial`, `PIT_Tag1`, `PIT_Tag2`, `TL_mm`, and `FL_mm`. These needed to be renamed
   and selected for.
2. We had to convert the `FL` and `TL` columns from cm to mm.
3. Standardize `Site` names.
4. Remove rows with missing `V_TagID`.
5. Standardize `Date` column.

### Apalach
This one had many unneeded columns also, hence the `select` command at the 
beginning.
``` {r manApal}
Apal <- Apal %>%
  select(1:21) %>%
  rename(PIT_Tag1 = PIT_New, PIT_Tag2 = Pit_Old) %>%
  mutate(
    FL_mm = FL_cm*10, 
    TL_mm = TL_cm*10,
    Date = as.Date(Date),
    Site = str_replace(Site, '_', ' ') %>% str_to_title
  ) %>%
  select(Site, Date, V_TagID, V_Serial, PIT_Tag1, PIT_Tag2, TL_mm, FL_mm) %>%
  filter(!is.na(V_TagID))
```


### Suwannee


``` {r manSuwa}
Suwa <- Suwa %>%
  rename(
    V_TagID = `ACOUSTIC TAG #`,
    PIT_Tag1 = `TAG 9    PIT TAG (ANTERIOR D FIN BASE)`,
    PIT_Tag2 = `TAG 10 EXTRA  OR AUX PIT TAG (INCL EXTRA PIT TAG 2)`,
    TL_mm = `TL mm`,
    FL_mm = `FL mm`,
    Site = `RIVER SYS`,
    Date = DATE
  ) %>%
  mutate(
    Date = as.Date(Date),
    Site = str_replace(Site, '_', ' ') %>% str_to_title
  ) %>%
  select(Site, Date, V_TagID, PIT_Tag1, PIT_Tag2, TL_mm, FL_mm) %>%
  filter(!is.na(V_TagID))
```


### Pearl

``` {r manPearl}
Pearl <- Pearl %>% 
  as.tbl %>% 
  mutate(
    Date = as.Date(Date, format = '%m/%d/%Y'),
    Site="Pearl", 
    FL_mm=FL.cm*10, 
    TL_mm=TL.cm*10
  ) %>%
  rename(
    V_TagID = Tel_tag_code, 
    PIT_Tag1 = Pit.Tag,
    PIT_Tag2 = old_Pit_tag
  ) %>%
  select(Site, Date, V_TagID, PIT_Tag1, PIT_Tag2, TL_mm, FL_mm) %>%
  filter(!is.na(V_TagID))
```

### Pascagoula

``` {r manPasc}
Pasc <- Pasc %>%
  mutate(
    Date = as.Date(Date_Tagged),
    Site = "Pascagoula",
    FL_mm = `FL(cm)`*10,
    TL_mm = `TL(cm)`*10
  ) %>%
  rename(
    V_TagID = Tag_ID,
    PIT_Tag1 = `Pit Tag`
  ) %>%
  select(Site, Date, V_TagID, PIT_Tag1, TL_mm, FL_mm) %>%
  filter(!is.na(V_TagID))
```




# Gathering by PIT and combining





``` {r, eval = F}


# Input data frames: Apal, Suwa, Pearl, Pasc

# Function to `gather` (i.e., collapse) PIT_Tag columns into one, resulting in more 
# rows but easier data frames to combine.
# Since I'm unsure of what sites might repeat PIT tags, I'm assigning them names that
# include the first 4 letters of the site.
gatherByPIT <- function(df){
  PIT_name_prefix <- str_c(str_sub(df$Site[1], 1, 4), '_')
  df %>%
    gather(PIT_name, PIT_Tag, starts_with('PIT_Tag', ignore.case = FALSE)) %>%
    mutate(
      PIT_name = str_replace(PIT_name, 'PIT_Tag', PIT_name_prefix)
    )
}

# Run above function and combine them all.
allSites <- lapply(list(Apal, Suwa, Pearl, Pasc), gatherByPIT) %>% 
  bind_rows


# I next want to figure out how many unique PIT Tag numbers are associated with 
# `V_TagID`s. Max appears to be 4.

allSites %>% 
  group_by(V_TagID) %>%
  summarize(uniquePITs = length(unique(PIT_Tag))) %>%
  select(uniquePITs) %>% 
  unlist %>% as.numeric %>% 
  table

```

